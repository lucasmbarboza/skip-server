# SKIP Server - RFC Compliant Implementation

[![RFC SKIP](https://img.shields.io/badge/RFC-SKIP%20draft--cisco--skip--02-blue)](https://datatracker.ietf.org/doc/draft-cisco-skip/)
[![Docker](https://img.shields.io/badge/Docker-Supported-2496ED?logo=docker)](https://www.docker.com/)
[![MySQL](https://img.shields.io/badge/MySQL-8.0-4479A1?logo=mysql)](https://www.mysql.com/)
[![Python](https://img.shields.io/badge/Python-3.8+-3776AB?logo=python)](https://www.python.org/)

This is a complete implementation of the **Secure Key Integration Protocol (SKIP)** server as specified in the IETF **draft-cisco-skip-02**.

## Overview

SKIP is a protocol that allows two participants (encryptors) to securely obtain keys from independent Key Providers, providing quantum resistance for existing secure channel protocols such as IKEv2, TLS, and MACsec.

### Main Features

- **RFC Compliant**: 100% compliance with draft-cisco-skip-02
- **Shared Database**: MySQL persistence for multiple Key Providers
- **Docker Ready**: Complete containerization with MySQL
- **Quantum Resistant**: Cryptographically secure key generation
- **Observability**: OpenTelemetry with logs, traces and metrics
- **Splunk Integration**: Automatic collection via OTEL Collector
- **Production Ready**: TLS 1.2/1.3 with PSK/Certificate authentication

## Architecture

```text
        Location A                                 Location B
+------------------------+              +------------------------+
|   +----------------+   |              |   +----------------+   |
|   |   Encryptor    |   |   IKEv2/     |   |   Encryptor    |   |
|   |   (Alice)      |==================|   |    (Bob)       |   |
|   +----------------+   |   TLS/IPsec  |   +----------------+   |
|           |            |              |           |            |
|      SKIP |            |              |      SKIP |            |
|           |            |              |           |            |
|   +----------------+   |              |   +----------------+   |
|   | Key Provider   |   |   Arbitrary  |   | Key Provider   |   |
|   |   (Alice)      |= = = = = = = = = =|   |    (Bob)       |   |
|   +----------------+   |  Sync Proto  |   +----------------+   |
+------------------------+              +------------------------+
           |                                           |
           +-------------------+   +-------------------+
                               |   |
                        +-------------+
                        |   MySQL     |
                        | (Shared DB) |
                        +-------------+
```

### Components

- **Encryptor**: Client requesting keys (IKEv2, TLS, MACsec, etc.)
- **Key Provider**: SKIP server that manages and synchronizes keys
- **MySQL Database**: Shared database for persistence
- **stunnel4**: TLS termination with PSK/Certificate authentication

## Shared Database Feature

The SKIP server uses a shared MySQL database between multiple Key Providers, allowing keys generated by one KP to be accessed by another authorized KP.

### Sharing Characteristics

- **Centralized Database**: MySQL shared between all Key Providers
- **Controlled Access**: remoteSystemID validation for authorization
- **Persistence**: Keys stored with metadata (size, timestamp, etc.)
- **Automatic Cleanup**: Removal of expired keys
- **Zeroization**: Keys can be removed after use (configurable)

## RFC SKIP Endpoints

### 1. GET /capabilities

Returns the Key Provider capabilities.

**Response:**

```json
{
    "entropy": true,
    "key": true,
    "algorithm": "pqc",
    "localSystemID": "KP_QuIIN_Server",
    "remoteSystemID": ["KP_QuIIN_Client", "KP_*_Test"]
}
```

### 2. GET /key?remoteSystemID=&lt;id&gt;&size=&lt;bits&gt;

Generates a new key and returns key + keyId.

**Parameters:**

- `remoteSystemID`: Remote system ID (required)
- `size`: Key size in bits (optional, default: 256)

**Response:**

```json
{
    "keyId": "1726e9ae76234fb1dd1283d4dca1911e1f93864d70f3069e",
    "key": "ad229dfb8a276e74c1f3b6c09349a69fb2fed73c541270663f0e5cbbfb031670"
}
```

### 3. GET /key/{keyId}?remoteSystemID=&lt;id&gt;

Retrieves a specific key by keyId.

**Response:**

```json
{
    "keyId": "1726e9ae76234fb1dd1283d4dca1911e1f93864d70f3069e",
    "key": "ad229dfb8a276e74c1f3b6c09349a69fb2fed73c541270663f0e5cbbfb031670"
}
```

### 4. GET /entropy?minentropy=&lt;bits&gt;

Returns random entropy.

**Parameters:**

- `minentropy`: Amount of entropy in bits (optional, default: 256)

**Response:**

```json
{
   "randomStr": "AD229DFB8A276E74C1F3B6C09349A69FB2FED73C541270663F0E5CBBFB031670",
   "minentropy": 256
}
```

## Additional Endpoints

### 1. POST /sync

Internal endpoint for communication between Key Providers.

**Usage:** Receives synchronization messages from other KPs (heartbeat, keys, capabilities)

### 2. GET /status/sync

Returns synchronization status.

**Response:**

```json
{
    "sync_enabled": true,
    "local_system_id": "KP_QuIIN_Server",
    "peer_count": 2,
    "peers": {
        "KP_QuIIN_Backup": {
            "endpoint": "192.168.1.100:8443",
            "status": "online",
            "last_heartbeat": 1634567890.123
        }
    }
}
```

### 3. GET /health

Health check with synchronization information.

**Response:**

```json
{
    "status": "ok",
    "timestamp": "2025-10-20T10:30:00",
    "database": "ok",
    "version": "1.0.0",
    "localSystemID": "KP_QuIIN_Server"
}
```

## TLS Configuration

According to RFC SKIP Table 1, we support:

| Mode | TLS Version | Cipher Suite | Requirement |
|------|-------------|--------------|-------------|
| PSK | TLS 1.2 | TLS_DHE_PSK_WITH_AES_256_CBC_SHA384 | RECOMMENDED |
| PSK | TLS 1.2 | TLS_DHE_PSK_WITH_AES_256_CBC_SHA | RECOMMENDED |
| Certificate/PSK | TLS 1.3 | TLS_AES_256_GCM_SHA384 | REQUIRED |

## Observability and Monitoring

The SKIP server includes a complete observability system based on **OpenTelemetry** with native **Splunk** integration.

### Observability Features

- **OpenTelemetry SDK**: Automated logs, traces and metrics
- **OTEL Collector**: Telemetry collection and export
- **Splunk Integration**: Production-ready dashboards and alerts
- **Distributed Tracing**: Complete request tracing
- **Custom Logs**: Structured logs with endpoint context

### Observability Architecture

```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   SKIP Server   │───▶│ OTEL Collector  │───▶│     Splunk      │
│  (Application)  │    │   (Processor)   │    │   (Storage)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
    ┌────▼────┐             ┌────▼────┐             ┌────▼────┐
    │  Logs   │             │ Metrics │             │Dashboards│
    │ Traces  │             │ Transform│             │ Alerts  │
    │Metrics  │             │ Enrichment│            │Analytics│
    └─────────┘             └─────────┘             └─────────┘
```

### OpenTelemetry Deployment

#### 1. OTEL Configuration (Recommended)

```bash
# 1. Configure environment variables
cp .env.example .env
# Edit Splunk and MySQL configurations

# 2. Run with complete observability
docker-compose -f docker-compose_otel.yml up -d

# 3. Check collector logs
docker logs otel-collector

# 4. Test endpoints with tracing
curl -k "http://localhost:8080/health"
curl -k "http://localhost:8080/capabilities"
```

#### 2. OTEL Environment Variables

Configure the following variables in `.env` file:

```bash
# OpenTelemetry Configuration
OTEL_SERVICE_NAME=skip-server
OTEL_SERVICE_VERSION=1.0.0
OTEL_ENVIRONMENT=production
OTEL_RESOURCE_ATTRIBUTES=service.name=skip-server,service.version=1.0.0

# External Splunk Configuration
SPLUNK_HEC_ENDPOINT=http://localhost:8088
SPLUNK_HEC_TOKEN=12345678-1234-1234-1234-123456789012

# Skip Server Configuration
SKIP_LOCAL_SYSTEM_ID=system_001
SKIP_REMOTE_SYSTEM_ID=system_002
ENVIRONMENT=development
```

### Collected Telemetry Types

#### 1. **Structured Logs**

- **REQUEST logs**: Method, path, endpoint, arguments, remote IP
- **RESPONSE logs**: Status, size, endpoint, response data
- **Key operations**: Generation, retrieval, zeroization
- **Database events**: Connections, queries, errors

Example REQUEST log:
```
REQUEST | method=GET | path=/key | endpoint=get_new_key | args=ImmutableMultiDict([('remoteSystemID', 'system_002'), ('size', '256')]) | remote_addr=172.23.0.1
```

Example RESPONSE log:
```
RESPONSE | status_code=200 | content_length=127 | endpoint=get_new_key | data={"key": "ad4a60c092763f5e...", "keyId": "4e1d61a7e704a6a1..."}
```

#### 2. **Distributed Traces**

- **HTTP spans**: Complete requests with timing
- **Database spans**: MySQL operations with queries
- **Application spans**: Business logic and processing
- **Custom spans**: SKIP-specific operations

#### 3. **Automatic Metrics**

- **HTTP metrics**: Latency, throughput, status codes
- **Database metrics**: Connection pool, query time
- **Application metrics**: Keys generated, cache hits
- **System metrics**: CPU, memory, network

### Ready Splunk Queries

#### Basic Monitoring

```spl
# View all SKIP Server logs
index=main sourcetype=skip:traces span.name="app_log"

# Filter logs by specific endpoint
index=main sourcetype=skip:traces span.name="app_log" log.message="*endpoint=health_check*"

# Performance analysis by endpoint
index=main sourcetype=skip:traces span.kind=server
| stats avg(duration) as avg_duration, count as request_count by http.route
| sort -avg_duration
```

#### Cryptographic Keys Analysis

```spl
# Complete audit of key operations
index=main sourcetype=skip:traces span.name="app_log" 
  (log.message="*KEY_GENERATED*" OR log.message="*KEY_RETRIEVED*")
| rex field=log.message "(?<action>KEY_\w+) \| key_id=(?<key_id>\w+)"
| stats count by action
```

#### Anomaly Detection

```spl
# Detect high latency in endpoints
index=main sourcetype=skip:traces span.kind=server
| where duration > 1000
| stats count by http.route, _time
| sort -count
```

### Available Dashboards

1. **SKIP Overview**: General status, throughput, latency
2. **Key Operations**: Generation, retrieval, zeroization of keys
3. **Database Performance**: MySQL queries, connections, locks
4. **Security Audit**: Access attempts, systemID validations
5. **Error Analysis**: Error logs with context and stack traces

### Observability Troubleshooting

#### Check OTEL Collector

```bash
# Collector status
docker logs otel-collector | tail -20

# Collector internal metrics
curl http://localhost:8888/metrics

# Debug pipeline
docker exec otel-collector cat /etc/otel-collector-config.yaml
```

#### Check Splunk Data

```spl
# Check if data is arriving
| rest /services/data/indexes 
| search title=skip_traces
| table title, currentDBSizeMB, totalEventCount
```

## Installation and Configuration

### Prerequisites

- **Docker & Docker Compose**: For containerization
- **MySQL 8.0**: Database (can be external)
- **stunnel4**: For TLS termination (required on host)

### Docker Installation (Recommended)

#### 1. Install stunnel4 on Host

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install stunnel4

# Configure stunnel4
sudo cp stunnel.conf /etc/stunnel/stunnel.conf
sudo cp psk.txt /etc/stunnel/psk.txt
sudo chmod 600 /etc/stunnel/psk.txt

# Enable stunnel4
echo "ENABLED=1" | sudo tee /etc/default/stunnel4
sudo systemctl restart stunnel4
```

#### 2. Clone and Configure

```bash
git clone <repository>
cd "SKIP Server"

# Edit environment variables in docker-compose.yml
# All configurations are in the 'environment' section
```

#### 3. Run with Docker Compose

```bash
# Before starting, configure variables in docker-compose.yml:
# - MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE
# - SKIP_LOCAL_SYSTEM_ID, SKIP_REMOTE_SYSTEM_ID_1

# Start services
docker compose up -d --build

# Check logs
docker compose logs -f skip_server

# Test TLS connectivity via stunnel4
curl -k "https://localhost:8443/capabilities"

# Test direct container access (no TLS)
curl -k "http://localhost:8080/capabilities"
```

#### 4. Environment Variables Configuration

All configurations are defined directly in `docker-compose.yml`:

```yaml
# docker-compose.yml
services:
  skip_server:
    network_mode: host  # Allows access to host MySQL
    environment:
      - FLASK_ENV=development
      - SKIP_LOCAL_SYSTEM_ID=KP_QuIIN_Server
      - SKIP_REMOTE_SYSTEM_ID_1=KP_QuIIN_Client
      - MYSQL_HOST=127.0.0.1
      - MYSQL_DATABASE=my_database_name
      - MYSQL_USER=my_user
      - MYSQL_PASSWORD=my_user_password_here
```

**Important**:

- Edit these variables in `docker-compose.yml` before running the container
- stunnel4 runs on host and redirects HTTPS (8443) to HTTP in container (8080)

### Manual Installation

#### 1. Install Dependencies

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3 python3-pip stunnel4 mysql-client

# Install Python dependencies
pip3 install -r requirements.txt
```

**Note**: `stunnel4` is a Linux system package for TLS termination, not a Python dependency.

#### 2. Configure MySQL

```sql
-- Create database and user
CREATE DATABASE skip_keys;
CREATE USER 'skip_user'@'%' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON skip_keys.* TO 'skip_user'@'%';
FLUSH PRIVILEGES;
```

**Note**: Database tables are automatically created by `skip_server.py` on first run through SQLAlchemy (`db.create_all()`).

#### 3. Configure stunnel4

```bash
# Copy configurations
sudo cp stunnel.conf /etc/stunnel/stunnel.conf
sudo cp psk.txt /etc/stunnel/psk.txt
sudo chmod 600 /etc/stunnel/psk.txt

# Enable stunnel4
echo "ENABLED=1" | sudo tee /etc/default/stunnel4
sudo systemctl restart stunnel4
```

#### 4. Start Server

```bash
# Development
export SKIP_ENV=development
python3 src/skip_server.py

# Production
export SKIP_ENV=production
python3 src/skip_server.py
```

**Note**: The server automatically initializes database tables on first run.

### Advanced Configuration

Use the `skip_sync_config.example.py` file as a base:

1. **Configure MySQL Database:**

```bash
# Create database and user
mysql -u root -p
CREATE DATABASE skip_db;
CREATE USER 'skip_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON skip_db.* TO 'skip_user'@'%';
FLUSH PRIVILEGES;
```

## Configuration

### Configuration via docker-compose.yml

The server is configured through environment variables defined in `docker-compose.yml`:

```yaml
environment:
  # Basic configurations
  - FLASK_ENV=development
  - SKIP_LOCAL_SYSTEM_ID=KP_QuIIN_Server
  - SKIP_REMOTE_SYSTEM_ID_1=KP_QuIIN_Client
  
  # MySQL configurations
  - MYSQL_HOST=127.0.0.1
  - MYSQL_DATABASE=my_database_name
  - MYSQL_USER=my_user
  - MYSQL_PASSWORD=my_user_password_here
  - MYSQL_ROOT_PASSWORD=your_root_password_here
```

For manual installation (without Docker), these same variables can be exported in the shell.

### skip_config.py File

Main configurations are in `src/skip_config.py`:

```python
class SKIPConfig:
    # Key Provider configurations
    LOCAL_SYSTEM_ID = os.getenv('SKIP_LOCAL_SYSTEM_ID', 'KP_QuIIN_Server')
    REMOTE_SYSTEM_IDS = [
        os.getenv('SKIP_REMOTE_SYSTEM_ID_1', 'KP_QuIIN_Client'),
    ]
    
    # Key configurations
    DEFAULT_KEY_SIZE = 256  # bits
    MIN_KEY_SIZE = 128      # bits
    MAX_KEY_SIZE = 512      # bits
    
    # Key zeroization
    ENABLE_KEY_ZEROIZATION = True
```

## File Structure

```text
SKIP Server/
├── src/
│   ├── skip_server.py          # Main SKIP server
│   ├── skip_config.py          # Configuration
│   ├── models.py               # Database models
│   ├── otel_config.py          # OpenTelemetry configuration
│   └── Dockerfile              # Container image
├── docker-compose.yml          # Basic orchestration
├── docker-compose_otel.yml     # Orchestration with OpenTelemetry
├── docker-compose_splunk.yml   # Orchestration with Splunk
├── otel-collector-config.yaml  # OTEL Collector configuration
├── .env.example                # Environment variables example
├── stunnel.conf                # TLS/PSK configuration
├── psk.txt                     # Pre-shared keys
├── splunk_otel_queries.spl     # Splunk queries for OTEL
├── test_rfc_compliance.py      # RFC compliance tests
├── test_specific_issue.py      # Specific issue tests
├── RFC_COMPLIANCE.md           # Compliance report
└── README.md                   # This file
```

## Security

### TLS PSK (Pre-Shared Key)

Communication is protected by TLS with pre-shared keys according to RFC SKIP:

- **PSK File:** `/etc/stunnel/psk.txt`
- **Format:** `identity:key_hex`
- **Minimum Size:** 256 bits (64 hex characters)

### Key Zeroization

- Keys are automatically removed from memory after use
- Implements RFC SKIP "use once, destroy" principle

### SystemID Validation

- Support for glob patterns (`*`, `?`, `[list]`)
- Remote ID validation according to configuration
- **Minimum Size:** 256 bits (64 hex characters)

### Key Zeroization

- Keys are automatically removed from memory after use
- Implements the "use once, destroy" principle from RFC SKIP

### SystemID Validation

- Support for glob patterns (`*`, `?`, `[list]`)
- Remote ID validation according to configuration

## Logs

- **stunnel4:** `/var/log/stunnel4/skip-server.log`
- **SKIP Server:** Container logs via `docker compose logs`
- **MySQL:** Database query logs (configurable)

## Testing and Validation

### Automated Tests

```bash
# Complete RFC compliance test
python3 test_rfc_compliance.py

# Specific issue test resolved
python3 test_specific_issue.py

# Synchronization test
python3 test_skip_sync.py
```

### Manual Tests via cURL

```bash
# Test capabilities
curl -k "http://localhost:8080/capabilities"

# Generate new key
curl -k "http://localhost:8080/key?remoteSystemID=192_168_71_25&size=256"

# Retrieve key by ID
curl -k "http://localhost:8080/key/YOUR_KEY_ID?remoteSystemID=192_168_71_15"

# Generate entropy
curl -k "http://localhost:8080/entropy?minentropy=128"

# Health check
curl -k "http://localhost:8080/health"
```

### Monitoring and Debug

```bash
# View container logs
docker compose logs -f skip_server

# Check database
docker exec -it mysql_container mysql -u skip_user -p skip_keys

# Debug query for keys
SELECT key_id, remote_system_id, size, created_at FROM `keys` ORDER BY created_at DESC LIMIT 10;

# Check TLS connectivity
openssl s_client -connect localhost:8443 -psk_identity cisco -psk YOUR_PSK_KEY
```

## HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | OK |
| 400 | Malformed keyId or key not found |
| 404 | Endpoint not found |
| 405 | Method not allowed (only GET supported) |
| 500 | Internal error reading/zeroizing key |
| 503 | Random number generator not available |

## IKEv2 Integration

SKIP can be integrated with IKEv2 PPK according to RFC 8784:

1. **Capabilities:** System ID exchange
2. **Key Request:** Obtain (keyId, key)
3. **Key Exchange:** keyId exchange via IKE_AUTH
4. **Key Retrieval:** Key recovery by keyId

## Troubleshooting

### Common Issues

1. **400 error on key retrieval**: Check remoteSystemID configuration and database
2. **Docker network issues**: Ensure `network_mode: host` for external MySQL
3. **TLS connection failure**: Check stunnel4 configuration and PSK file
4. **Database connection**: Check MySQL credentials and network access

### Debug Commands

```bash
# Check server configuration
docker exec skip_server python3 -c "from skip_config import get_config; print(get_config().validate())"

# Test database connection
docker exec skip_server python3 -c "from models import db; print(db.engine.execute('SELECT 1').fetchone())"

# Verify TLS certificates
openssl s_client -connect localhost:8443 -showcerts
```

## Development

### Development Configuration

```bash
export SKIP_ENV=development
export SKIP_DEBUG=true
python3 src/skip_server.py
```

### Production Configuration

```bash
export SKIP_ENV=production
export SKIP_DEBUG=false
python3 src/skip_server.py
```

## References

- **RFC SKIP:** draft-cisco-skip-02
- **RFC 8784:** IKEv2 PPK Extension
- **RFC 8446:** TLS 1.3
- **RFC 9110:** HTTP Semantics

## License

This project implements public IETF specifications and is available for use according to RFC implementation guidelines.
